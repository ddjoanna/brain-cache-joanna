# 兩階段提交協議（2PC）vs SAGA 協議

> 兩階段提交協議（2PC）與 SAGA 協議是分布式系統中常用的兩種分布式事務管理機制，主要用於確保多節點間資料的一致性，但其原理與適用場景有所不同。

## 兩階段提交協議（2PC）

**基本概念：**  
2PC 是一種分布式原子提交協議，主要用於確保分散式系統中所有參與節點的事務要麼全部提交，要麼全部回滾，從而保證強一致性[1][2][6]。

**角色：**

- 協調者（Coordinator）：負責協調所有參與者的提交決策，通常系統中只有一個。
- 參與者（Participants）：執行實際事務操作的節點，可能有多個。

**執行過程：**

1. **準備階段（Prepare Phase）**：協調者向所有參與者發送「準備提交」請求，參與者執行本地事務並回覆「同意」或「拒絕」。
2. **提交階段（Commit Phase）**：如果所有參與者均同意，協調者發出「提交」指令；否則發出「回滾」指令。參與者根據指令執行提交或回滾操作。

**優點：**

- 保證分布式事務的原子性和持久性，確保資料強一致性[1][6]。

**缺點：**

- 協議是同步阻塞的，參與者在等待協調者指令時會鎖定資源，導致性能下降。
- 單點故障問題：協調者故障會導致參與者長時間阻塞。
- 在第二階段提交時，協調者若掛掉可能導致部分節點提交、部分節點未提交，造成資料不一致[1][6]。

---

## SAGA 協議

**基本概念：**  
SAGA 是一種基於補償操作的分布式事務管理機制，將一個長事務拆分成多個子事務，每個子事務完成後立即提交，如果後續子事務失敗，則依序執行補償事務回滾之前的操作[無直接搜尋結果，以下為推論]。

**執行過程：**

- 將整個事務拆分成多個獨立的子事務，每個子事務成功後立即提交。
- 若任一子事務失敗，則執行相應的補償事務來撤銷之前已完成的子事務，達到最終一致性。

**優點：**

- 非阻塞，子事務獨立執行，提升系統可用性和響應速度。
- 適用於長時間運行的事務和微服務架構。

**缺點：**

- 無法保證強一致性，只能保證最終一致性。
- 補償事務設計較為複雜，且不適用於所有場景。

---

## 2PC 與 SAGA 協議比較

| 特性       | 兩階段提交（2PC）                      | SAGA 協議                        |
| ---------- | -------------------------------------- | -------------------------------- |
| 一致性保障 | 強一致性（原子性）                     | 最終一致性                       |
| 執行方式   | 同步阻塞，等待所有節點回應             | 非阻塞，子事務獨立提交           |
| 容錯性     | 協調者故障導致阻塞，存在單點故障風險   | 補償機制處理失敗，提高容錯性     |
| 適用場景   | 短事務、需要嚴格一致性的分布式事務     | 長事務、微服務架構下的分布式事務 |
| 複雜度     | 協議較簡單，但需處理阻塞和故障恢復問題 | 補償邏輯複雜，需要設計補償事務   |

---

總結來說，2PC 適合需要強一致性且事務較短的場景，但存在阻塞和單點故障問題；而 SAGA 則適用於較長且可拆分的事務，通過補償機制實現最終一致性，提升系統可用性和彈性。選擇哪種協議需根據系統需求和場景特性決定。

---

**參考來源:**

[1] https://blog.csdn.net/a1102325298/article/details/96481642 \
[2] https://zh.wikipedia.org/zh-tw/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4 \
[3] https://www.cnblogs.com/segeon/p/10381122.html \
[4] https://zh.wikipedia.org/zh-cn/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4 \
[5] https://www.cnblogs.com/luxiaodai/p/14371586.html \
[6] https://yifan-online.com/zh/km/article/detail/3728 \
[7] http://matt33.com/2018/07/08/distribute-system-consistency-protocol/?hmsr=toutiao.io \
[8] https://blog.csdn.net/galoiszhou/article/details/142853002

---

[返回目錄](./../README.md)
