# Race condition（競態條件）

> 指在多個程序或執行緒同時存取並修改共享資源時，由於執行順序或時機不確定，導致系統行為不可預期或資料錯誤的問題[1][2][3]。

---

## 常見情境

- **資料庫交易衝突（Lost update）**  
  兩個交易同時讀取並修改同一筆資料，最後一個提交覆蓋了前一個的修改，導致部分更新遺失。例如兩個交易同時讀取 X=0，一個加 2 變成 2，一個加 3 變成 3，最後結果非預期的 5，而是 3 或 2[1]。

- **多執行緒變數競爭**  
  多個執行緒同時讀寫同一變數，未同步導致讀取到不一致或錯誤的值，如計數器錯誤增加[5][7]。

- **檔案存取競爭**  
  多個程序同時讀寫同一檔案，可能導致檔案損壞或非法內容，例如攻擊者利用競態條件替換檔案造成安全漏洞[3]。

- **高併發系統中共享資源操作**  
  多個請求同時操作共享資源，若無適當控制，會產生資料不一致或系統錯誤[4][6]。

---

## 解決方案

- **鎖（Locking）機制**  
  使用互斥鎖（Mutex）、讀寫鎖（Read-Write Lock）等同步原語，確保同一時間只有一個程序能修改共享資源，避免同時寫入導致錯誤[2][7]。

- **事務（Transaction）與隔離級別**  
  資料庫透過事務管理與隔離級別（如 Serializable）控制並發，避免讀取未提交資料或更新遺失[1]。

- **原子操作**  
  利用硬體或軟體提供的原子指令，確保複合操作不可中斷，避免中間狀態被其他程序讀取或修改。

- **樂觀鎖與版本控制**  
  讀取資料時帶上版本號，更新時檢查版本是否變更，若有衝突則重試，適用於衝突較少的場景。

- **排程與序列化**  
  將對共享資源的操作排入隊列，依序執行，保證操作有序。

- **使用不可變資料結構**  
  減少共享可變狀態，降低競態條件發生機率。

---

## 總結

Race condition 是多程序或多執行緒環境中常見且嚴重的問題，可能導致資料錯誤、系統崩潰或安全漏洞。透過鎖機制、事務隔離、原子操作等方法能有效避免競態條件，確保系統穩定與資料一致。

---

**參考來源:**

[1] https://vincent87720.github.io/race-condition-intro/ \
[2] https://en.wikipedia.org/wiki/Race_condition \
[3] https://www.automox.com/blog/vulnerability-definition-race-condition \
[4] https://blog.twjoin.com/%E9%AB%98%E4%BD%B5%E7%99%BC%E7%9A%84%E7%AB%B6%E7%88%AD%E9%97%9C%E4%BF%82-race-condition-3751a822c7c9 \
[5] https://hackmd.io/@emmmmmma/Sy5T6Otu6 \
[6] https://dagster.io/glossary/race-condition \
[7] https://ithelp.ithome.com.tw/articles/10239243 \
[8] https://zh.wikipedia.org/zh-hant/%E7%AB%B6%E7%88%AD%E5%8D%B1%E5%AE%B3

---

[返回目錄](./../README.md)
