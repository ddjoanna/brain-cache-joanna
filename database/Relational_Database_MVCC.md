# 多版本並發控制（MVCC）

> 多版本並發控制（Multi-Version Concurrency Control，簡稱 MVCC）是一種資料庫管理系統中用來處理多筆交易同時讀寫資料的技術。它透過維護資料的多個版本，讓交易能夠在不互相阻塞的情況下並行執行，提升系統效能與資料一致性[1][3][6]。

---

## 運作原理

- **資料多版本管理**：每筆資料在被修改時，不會直接覆寫原資料，而是建立一個新版本，舊版本依然保留[1][5]。
- **交易快照（Snapshot）**：每個交易開始時會取得資料庫當時的快照，讀取資料時只看到該快照時間點之前已提交的版本[1][6]。
- **版本可見性判斷**：系統根據交易 ID 或時間戳判斷資料版本是否對當前交易可見，避免讀取未提交或其他交易正在修改的資料[1][7]。
- **讀寫分離**：讀取操作不會阻塞寫入，寫入操作也不會阻塞讀取，提升並行度[3][6]。
- **垃圾回收機制**：過期且不再被任何交易使用的舊版本會被清理，以釋放空間（如 PostgreSQL 的 VACUUM）[4][5]。

---

## 優點

- **提升並發效能**：讀取操作不需等待寫入鎖，寫入操作也不阻塞讀取，減少鎖競爭[1][3]。
- **維持資料一致性**：符合 ACID 中的隔離性，避免脏讀、不可重複讀等問題[1][6]。
- **良好的使用者體驗**：交易能看到一致且穩定的資料快照，避免讀取到不完整或錯誤資料[5][7]。

---

## 缺點

| 缺點項目               | 說明                                                                                            |
| ---------------------- | ----------------------------------------------------------------------------------------------- |
| **空間浪費**           | 多版本資料會產生大量死元組（過時版本），佔用磁碟空間與索引資源，需定期清理（如 VACUUM）[4][5]。 |
| **系統複雜度高**       | 需管理多版本資料、版本可見性判斷與垃圾回收機制，增加系統設計與維護難度[5][6]。                  |
| **寫入性能影響**       | 頻繁更新會產生大量版本，寫入時需維護版本鏈，衝突多時回溯重試導致效能下降[2][7]。                |
| **幻讀問題未完全解決** | MVCC 可避免脏讀與不可重複讀，但幻讀仍可能發生，需搭配鎖機制防範[1][6]。                         |
| **資源消耗增加**       | 多版本資料存儲與管理增加存儲空間與 CPU 負擔，對資源有限環境不友善[5][6]。                       |

---

## 主流資料庫的應用

- **MySQL InnoDB**  
  利用 MVCC 實現一致性讀取，透過隱藏欄位記錄版本資訊，並使用 Undo Log 保存舊版本資料，搭配鎖機制處理寫入衝突[3][4][8]。

- **PostgreSQL**  
  採用基於交易 ID 的 MVCC，為每筆資料行維護多版本，並透過 VACUUM 機制定期清理死元組，確保空間回收[4][6]。

- **Amazon Aurora PostgreSQL**  
  使用基於時間戳的 MVCC，支援分散式交易，透過比較交易提交時間與快照時間判斷版本可見性[6]。

---

## 結論

MVCC 是一種強大且廣泛應用的並發控制技術，透過多版本資料管理，有效提升資料庫在多交易並行操作時的效能與一致性。然而，MVCC 也存在空間膨脹、系統複雜度高及寫入性能受限等缺點，需結合適當的垃圾回收與鎖機制，才能達到最佳的系統效能與穩定性[1][5][6]。

---

**參考來源:**

[1] https://zh.wikipedia.org/zh-hant/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6 \
[2] https://www.cnblogs.com/jelly12345/p/14889331.html \
[3] https://developer.aliyun.com/article/1347250 \
[4] https://blog.csdn.net/m0_57697768/article/details/130371202 \
[5] https://github.com/Knowledge-Precipitation-Tribe/Dive-into-MySQL/blob/master/shu-ju-biao-cao-zuo/bing-fa-kong-zhi/mvcc.md \
[6] https://developer.aliyun.com/article/1487487 \
[7] https://draveness.me/database-concurrency-control/ \
[8] https://opensource.actionsky.com/20221221-mvcc/

---

[返回目錄](./../README.md)
